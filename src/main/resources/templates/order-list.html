
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Order List - CampusCart</title>
  <link rel="stylesheet" href="../assets/css/theme.min.css" />
  <link href="../assets/libs/bootstrap-icons/font/bootstrap-icons.min.css" rel="stylesheet" />
  <link href="../assets/libs/feather-webfont/dist/feather-icons.css" rel="stylesheet" />
  <link href="../assets/libs/simplebar/dist/simplebar.min.css" rel="stylesheet" />
</head>

<body>
  <!-- navbar -->
  <div th:replace="fragments/Nav :: admin_nav"></div>

  <div class="main-wrapper">
    <!-- sidebar -->
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <!-- main content -->
    <main class="main-content-wrapper">
      <div class="container">
        <div class="row mb-8">
          <div class="col-md-12">
            <h2>Order List</h2>
          </div>
        </div>

        <div class="row">
          <div class="col-xl-12 col-12 mb-5">
            <div class="card h-100 card-lg">
              <div class="p-6">
                <div class="row justify-content-between">
                  <div class="col-md-4">
                    <form class="d-flex" th:action="@{/admin/orders/search}" method="get">
                      <input class="form-control" type="search" name="query" placeholder="Search..." />
                    </form>
                  </div>
                  <div class="col-md-3">
                    <select class="form-select" th:name="status">
                      <option value="">All Status</option>
                      <option value="SUCCESS">Success</option>
                      <option value="PENDING">Pending</option>
                      <option value="CANCEL">Cancel</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-centered table-hover text-nowrap table-borderless mb-0 table-with-checkbox">
                    <thead class="bg-light">
                      <tr>
                        <th><input class="form-check-input" type="checkbox" id="checkAll" /></th>
                        <th>Order ID</th>
                        <th>Order Date</th>
                          <th>Status</th>
                          <th>Amount</th>
                          <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="ordersTableBody">

                    </tbody>
                  </table>
                </div>
              </div>




            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="orderDetailsContent">
        Loading...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

  <script src="../assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/libs/simplebar/dist/simplebar.min.js"></script>
  <script src="../assets/js/theme.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
   $(document).ready(function () {
  let ordersData = [];

  function loadOrders() {
    $.ajax({
      url: '/article/allorders',
      method: 'GET',
      dataType: 'json',
      success: function (data) {
        ordersData = data;  // store all order data globally

        const $tbody = $('#ordersTableBody');
        $tbody.empty(); // Clear any existing rows

        data.forEach(order => {
          const orderDate = order.orderDate ? new Date(order.orderDate).toLocaleDateString() : '';

          // Status dropdown HTML with current status selected
          const statusOptions = ['SUCCESS', 'PENDING', 'CANCEL']
            .map(status => `<option value="${status}" ${order.orderStatus === status ? 'selected' : ''}>${status}</option>`)
            .join('');

          const row = `
            <tr data-order-id="${order.id}">
              <td><input class="form-check-input" type="checkbox" /></td>
              <td>${order.id}</td>
              <td>${orderDate}</td>
              <td>
                <select class="form-select order-status-dropdown">
                  ${statusOptions}
                </select>
              </td>
              <td>${order.orderTotal}</td>
              <td>
                <button type="button" class="btn btn-sm btn-primary btn-view-order">View</button>

              </td>
            </tr>
          `;

          $tbody.append(row);
        });
      },
      error: function (xhr, status, error) {
        console.error('Error fetching orders:', error);
      }
    });
  }

  // Initial load
  loadOrders();

  // Change order status handler (your existing code)
  $('#ordersTableBody').on('change', '.order-status-dropdown', function () {
    const $select = $(this);
    const newStatus = $select.val();
    const orderId = $select.closest('tr').data('order-id');

    $.ajax({
      url: `/article/orders/${orderId}/status`,
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ orderStatus: newStatus }),
      success: function () {
        alert(`Order #${orderId} status updated to ${newStatus}`);
      },
      error: function () {
        alert('Failed to update order status');
        loadOrders();
      }
    });
  });

  // View button click: open modal with preloaded data
  $('#ordersTableBody').on('click', '.btn-view-order', function () {
    const orderId = $(this).closest('tr').data('order-id');
    const order = ordersData.find(o => o.id === orderId);

    if (!order) {
      alert('Order data not found!');
      return;
    }

    // Build modal content
    const orderDate = order.orderDate ? new Date(order.orderDate).toLocaleString() : '';
    const shippingDate = order.shippingDate ? new Date(order.shippingDate).toLocaleString() : '';
    const user = order.user || {};
    const address = user.address || {};

    const html = `
      <p><strong>Order ID:</strong> ${order.id}</p>
      <p><strong>Order Date:</strong> ${orderDate}</p>
      <p><strong>Shipping Date:</strong> ${shippingDate}</p>
      <p><strong>Status:</strong> ${order.orderStatus}</p>
      <p><strong>Total Amount:</strong> ${order.orderTotal}</p>
      <hr />
      <h5>User Info</h5>
      <p><strong>Username:</strong> ${user.username || ''}</p>
      <p><strong>Name:</strong> ${user.firstName || ''} ${user.lastName || ''}</p>
      <p><strong>Email:</strong> ${user.email || ''}</p>
      <h5>Address</h5>
      <p>${address.streetAddress || ''}</p>
      <p>${address.city || ''}, ${address.country || ''}, ${address.zipCode || ''}</p>
    `;

    $('#orderDetailsContent').html(html);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
    modal.show();
  });

});
loadOrders()
  </script>

</body>

</html>